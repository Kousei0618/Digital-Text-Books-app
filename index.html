<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PDFæ•™ç§‘æ›¸ï¼‹æ‰‹æ›¸ãè©¦ä½œå“</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    #home { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; width: 100vw; height: 100vh; background: #f0f0f0; }
    .book-cover { margin: 10px; width: 150px; height: 200px; background-size: cover; background-position: center; border: 2px solid #333; cursor: pointer; }
    #container { position: relative; width: 100vw; height: 100vh; display: none; }
    canvas { position: absolute; top: 0; left: 0; }
    .toolbar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 5px; display:flex; align-items:center; gap:5px; flex-wrap:wrap; }
    .color-btn { width:24px; height:24px; border:none; cursor:pointer; border-radius:3px; }
    #size-display { display: inline-block; border-radius: 50%; vertical-align: middle; margin-left: 5px; background-color: black; }
    #back-btn { position: absolute; top: 10px; left: 10px; z-index: 20; padding: 5px 10px; font-size: 14px; }
  </style>
</head>
<body>
  <div id="home"></div>
  <button id="back-btn" style="display:none;" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  <div class="toolbar" id="toolbar" style="display:none;">
    <button onclick="prevPage()">â—€ å‰ã¸</button>
    <button onclick="nextPage()">æ¬¡ã¸ â–¶</button>
    <span>ãƒšãƒ¼ã‚¸: <span id="page_num"></span> / <span id="page_count"></span></span>
    <button id="pen-btn">ãƒšãƒ³</button>
    <button id="eraser-btn">æ¶ˆã—ã‚´ãƒ </button>
    <!-- è‰²ãƒ‘ãƒ¬ãƒƒãƒˆ -->
    <span>è‰²:
      <button class="color-btn" style="background-color:#000000;"></button>
      <button class="color-btn" style="background-color:#FF0000;"></button>
      <button class="color-btn" style="background-color:#0000FF;"></button>
      <button class="color-btn" style="background-color:#008000;"></button>
      <button class="color-btn" style="background-color:#FFA500;"></button>
      <button class="color-btn" style="background-color:#800080;"></button>
      <button class="color-btn" style="background-color:#00FFFF;"></button>
      <button class="color-btn" style="background-color:#FFC0CB;"></button>
    </span>
    <label>å¤ªã•: <input type="range" id="size-slider" min="1" max="20" value="2"><span id="size-display"></span></label>
    <button onclick="clearDrawCanvas()">æ›¸ãè¾¼ã¿æ¶ˆå»</button>
  </div>
  <div id="container">
    <canvas id="pdf-canvas"></canvas>
    <canvas id="draw-canvas"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";

    let pdfDoc = null, pageNum = 1;
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const drawCanvas = document.getElementById('draw-canvas');
    const drawCtx = drawCanvas.getContext('2d');
    let drawing = false, penMode = true, eraserMode = false, drawings = {}, penColor = '#000000';

    const home = document.getElementById('home');
    const toolbar = document.getElementById('toolbar');
    const backBtn = document.getElementById('back-btn');

    const sizeSlider = document.getElementById('size-slider');
    const sizeDisplay = document.getElementById('size-display');

    function updateSizeDisplay() {
      const size = sizeSlider.value;
      sizeDisplay.style.width = size + 'px';
      sizeDisplay.style.height = size + 'px';
      drawCtx.lineWidth = size;
    }
    updateSizeDisplay();
    sizeSlider.addEventListener('input', updateSizeDisplay);

    // ãƒšãƒ³ãƒ»æ¶ˆã—ã‚´ãƒ åˆ‡æ›¿
    document.getElementById('pen-btn').addEventListener('click', () => {
      penMode = true; eraserMode = false;
      drawCtx.globalCompositeOperation = 'source-over';
      drawCtx.strokeStyle = penColor;
      drawCtx.lineWidth = sizeSlider.value;
    });
    document.getElementById('eraser-btn').addEventListener('click', () => {
      penMode = false; eraserMode = true;
      drawCtx.globalCompositeOperation = 'destination-out';
      drawCtx.lineWidth = sizeSlider.value;
    });

    // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆé¸æŠ
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        penColor = btn.style.backgroundColor;
        penMode = true;
        eraserMode = false;
        drawCtx.globalCompositeOperation = 'source-over';
        drawCtx.strokeStyle = penColor;
        drawCtx.lineWidth = sizeSlider.value;
      });
    });

    function resizeCanvases(width, height) {
      canvas.width = width;
      canvas.height = height;
      drawCanvas.width = width;
      drawCanvas.height = height;
    }

    function renderPage(num) {
      if(!pdfDoc) return;
      pdfDoc.getPage(num).then(page => {
        const containerWidth = window.innerWidth;
        const containerHeight = window.innerHeight;
        const viewport = page.getViewport({scale:1});
        const scaleFactor = Math.min(containerWidth / viewport.width, containerHeight / viewport.height);
        const scaledViewport = page.getViewport({scale: scaleFactor});
        resizeCanvases(scaledViewport.width, scaledViewport.height);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        page.render({canvasContext: ctx, viewport: scaledViewport});
        drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
        if(drawings[num]) drawCtx.putImageData(drawings[num],0,0);
        document.getElementById('page_num').textContent = num;
      });
    }

    function prevPage() { if(pageNum<=1) return; saveDrawings(); pageNum--; renderPage(pageNum); }
    function nextPage() { if(!pdfDoc || pageNum>=pdfDoc.numPages) return; saveDrawings(); pageNum++; renderPage(pageNum); }

    function startDraw(x,y){drawing=true;drawCtx.beginPath();drawCtx.moveTo(x,y);}
    function drawMove(x,y){if(drawing){drawCtx.lineTo(x,y);drawCtx.stroke();}}
    function endDraw(){drawing=false;}
    function saveDrawings(){drawings[pageNum]=drawCtx.getImageData(0,0,drawCanvas.width,drawCanvas.height);}
    function clearDrawCanvas(){drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height); saveDrawings();}

    drawCanvas.addEventListener('mousedown', e=>startDraw(e.offsetX,e.offsetY));
    drawCanvas.addEventListener('mousemove', e=>drawMove(e.offsetX,e.offsetY));
    drawCanvas.addEventListener('mouseup', endDraw);
    drawCanvas.addEventListener('mouseout', endDraw);
    drawCanvas.addEventListener('touchstart', e=>{if(e.touches.length===1){let rect=drawCanvas.getBoundingClientRect();let t=e.touches[0]; startDraw(t.clientX-rect.left, t.clientY-rect.top);}});
    drawCanvas.addEventListener('touchmove', e=>{if(e.touches.length===1){let rect=drawCanvas.getBoundingClientRect();let t=e.touches[0]; drawMove(t.clientX-rect.left,t.clientY-rect.top);}});
    drawCanvas.addEventListener('touchend', endDraw);

    window.addEventListener('resize', ()=>renderPage(pageNum));

    const textbooks = [
      { title: 'æ•°å­¦', url: 'https://raw.githubusercontent.com/Kousei0618/Digital-Text-Books-app/eedb7378697efb63afe56cf197053191a45cd291/tableofcontents.pdf' }
    ];

    function createBookCoverFromPDF(book) {
      pdfjsLib.getDocument(book.url).promise.then(pdf => {
        pdf.getPage(1).then(page => {
          const viewport = page.getViewport({scale:0.5});
          const offCanvas = document.createElement('canvas');
          const offCtx = offCanvas.getContext('2d');
          offCanvas.width = viewport.width;
          offCanvas.height = viewport.height;
          page.render({canvasContext: offCtx, viewport: viewport}).promise.then(() => {
            book.coverDataURL = offCanvas.toDataURL();
            addBookCoverToHome(book);
          });
        });
      }).catch(err => { console.error(err); alert('PDFã®è¡¨ç´™ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); });
    }

    function addBookCoverToHome(book) {
      const div = document.createElement('div');
      div.className = 'book-cover';
      div.style.backgroundImage = `url(${book.coverDataURL})`;
      div.title = book.title;
      div.onclick = () => {
        history.pushState({page:'book'}, '', '');
        home.style.display = 'none';
        container.style.display = 'block';
        toolbar.style.display = 'flex';
        backBtn.style.display = 'block';
        loadBookFromURL(book.url);
      };
      home.appendChild(div);
    }

    function loadBookFromURL(url) {
      pdfjsLib.getDocument(url).promise.then(pdf => {
        pdfDoc = pdf;
        document.getElementById('page_count').textContent = pdf.numPages;
        pageNum = 1;
        renderPage(pageNum);
      }).catch(err => { console.error(err); alert('PDFã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚'); });
    }

    function goHome() {
      container.style.display = 'none';
      toolbar.style.display = 'none';
      backBtn.style.display = 'none';
      home.style.display = 'flex';
    }

    window.addEventListener('popstate', (event) => { goHome(); });

    textbooks.forEach(book => createBookCoverFromPDF(book));
  </script>
</body>
</html>
